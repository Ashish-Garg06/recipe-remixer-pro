<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recipe Remixer Pro - AI Powered</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <!-- Netlify will inject the real value -->
  <script>
    window.HF_API_KEY = "";
  </script>
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    // Icon components
    const ChefHat = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" x2="18" y1="17" y2="17"/></svg>;
    const Sparkles = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/></svg>;
    const AlertCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
    const Loader2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
    const Check = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 6 9 17l-5-5"/></svg>;
    const Camera = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>;
    const Save = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
    const Share2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>;
    const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
    const ShoppingCart = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>;
    const X = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;

    // Simple localStorage polyfill for demo
    window.storage = {
      async get(key) {
        const value = localStorage.getItem(key);
        return value ? { key, value, shared: false } : null;
      },
      async set(key, value) {
        localStorage.setItem(key, value);
        return { key, value, shared: false };
      },
      async delete(key) {
        localStorage.removeItem(key);
        return { key, deleted: true, shared: false };
      },
      async list(prefix) {
        const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix || ''));
        return { keys, prefix, shared: false };
      }
    };

    function RecipeRemixer() {
      const [recipe, setRecipe] = useState('');
      const [inventory, setInventory] = useState('');
      const [remixedRecipe, setRemixedRecipe] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [savedRecipes, setSavedRecipes] = useState([]);
      const [shoppingList, setShoppingList] = useState([]);
      const [shareUrl, setShareUrl] = useState('');
      const [showShareModal, setShowShareModal] = useState(false);
      const [dietaryRestrictions, setDietaryRestrictions] = useState({
        vegetarian: false, vegan: false, glutenFree: false, dairyFree: false, nutFree: false
      });
      const [calories, setCalories] = useState(null);
      const [imageAnalyzing, setImageAnalyzing] = useState(false);

      useEffect(() => { loadSavedRecipes(); }, []);

      const loadSavedRecipes = async () => {
        try {
          const keys = await window.storage.list('recipe:');
          if (keys && keys.keys) {
            const recipes = await Promise.all(
              keys.keys.map(async key => {
                const result = await window.storage.get(key);
                return result ? JSON.parse(result.value) : null;
              })
            );
            setSavedRecipes(recipes.filter(Boolean));
          }
        } catch (err) { console.log('No saved recipes yet'); }
      };

       //removed the image upload for now
        const handleImageUpload = () => {
        alert("Image ingredient detection is disabled.Hugging Face FREE tier does NOT support image understanding well. i can only afford free tier API");
        };


      const remixRecipe = async () => {
  if (!recipe.trim()) { setError('Please enter a recipe'); return; }
  if (!inventory.trim()) { setError('Please enter your available ingredients'); return; }

  setLoading(true);
  setError('');
  setRemixedRecipe('');
  setCalories(null);
  setShoppingList([]);

  try {
    const restrictions = Object.entries(dietaryRestrictions)
      .filter(([_, v]) => v)
      .map(([k]) => k);

    const restrictionsText =
      restrictions.length > 0
        ? `\n\nDIETARY RESTRICTIONS: ${restrictions.join(', ')}`
        : '';

    const prompt = `You are a professional chef and nutritionist.

ORIGINAL RECIPE:
${recipe}

AVAILABLE INGREDIENTS:
${inventory}${restrictionsText}

Analyze and adapt the recipe. Format EXACTLY as:
## Remixed Recipe: [name]
### Ingredient Substitutions:
[explanations]
### Updated Ingredients List:
[complete list]
### Adjusted Instructions:
[steps]
### Chef's Notes:
[tips]
### Nutritional Information:
Total Calories: [number only]
### Shopping List:
[comma-separated missing ingredients or "None - you have everything!"]`;

     const response = await fetch("/.netlify/functions/remix", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
    },
    body: JSON.stringify({
        prompt: prompt,
    }),
    });

    const data = await response.json();
    console.log("HF RAW RESPONSE:", data);

    let recipeText = "No response from AI";

    if (data?.choices?.length > 0) {
    recipeText =
        data.choices[0].message?.content ||
        data.choices[0].text ||
        recipeText;
    }

    if (data?.error) {
    recipeText = `AI Error: ${data.error}`;
    }

    setRemixedRecipe(recipeText);

    // Optional parsing (best-effort)
    const calorieMatch = recipeText.match(/Total Calories:\s*(\d+)/i);
    if (calorieMatch) setCalories(parseInt(calorieMatch[1]));

    const shoppingMatch = recipeText.match(/### Shopping List:\s*\n(.+?)(?=\n###|\n\n|$)/s);
    if (shoppingMatch) {
      const items = shoppingMatch[1]
        .split(',')
        .map(i => i.trim())
        .filter(i => i && !i.toLowerCase().includes('none'));
      setShoppingList(items);
    }

  } catch (err) {
    setError(`Failed to remix recipe: ${err.message}`);
  } finally {
    setLoading(false);
  }
};


      const saveRecipe = async () => {
        if (!remixedRecipe) return;
        const recipeData = {
          id: Date.now().toString(),
          name: remixedRecipe.match(/## Remixed Recipe: (.+)/)?.[1] || 'Untitled',
          content: remixedRecipe,
          originalRecipe: recipe,
          inventory: inventory,
          calories: calories,
          timestamp: new Date().toISOString(),
          dietaryRestrictions: Object.entries(dietaryRestrictions).filter(([_, v]) => v).map(([k, _]) => k)
        };
        try {
          await window.storage.set(`recipe:${recipeData.id}`, JSON.stringify(recipeData));
          await loadSavedRecipes();
          alert('Recipe saved!');
        } catch (err) {
          setError('Failed to save recipe');
        }
      };

      const deleteRecipe = async (id) => {
        try {
          await window.storage.delete(`recipe:${id}`);
          await loadSavedRecipes();
        } catch (err) {
          setError('Failed to delete recipe');
        }
      };

      const loadRecipe = (recipeData) => {
        setRecipe(recipeData.originalRecipe);
        setInventory(recipeData.inventory);
        setRemixedRecipe(recipeData.content);
        setCalories(recipeData.calories);
        const newRestrictions = { vegetarian: false, vegan: false, glutenFree: false, dairyFree: false, nutFree: false };
        if (recipeData.dietaryRestrictions) {
          recipeData.dietaryRestrictions.forEach(r => { newRestrictions[r] = true; });
        }
        setDietaryRestrictions(newRestrictions);
      };

      const shareRecipe = () => {
        if (!remixedRecipe) return;
        const recipeData = { recipe, inventory, remixed: remixedRecipe, restrictions: dietaryRestrictions };
        const encoded = btoa(JSON.stringify(recipeData));
        const url = `${window.location.origin}${window.location.pathname}?shared=${encoded}`;
        setShareUrl(url);
        setShowShareModal(true);
      };

      const copyShareUrl = () => {
        navigator.clipboard.writeText(shareUrl);
        alert('Link copied!');
      };

      const exampleRecipe = `Chicken Alfredo Pasta

Ingredients:
- 1 lb fettuccine
- 2 chicken breasts
- 2 cups heavy cream
- 1 cup parmesan
- 4 cloves garlic
- 3 tbsp butter
- Salt and pepper
- Fresh parsley`;

      const exampleInventory = `spaghetti, shrimp, milk, cream cheese, cheddar, olive oil, garlic powder, black pepper, basil`;

      const loadExample = () => {
        setRecipe(exampleRecipe);
        setInventory(exampleInventory);
        setRemixedRecipe('');
        setError('');
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-orange-50 via-white to-amber-50">
          <div className="max-w-7xl mx-auto p-6">
            <div className="text-center mb-8">
              <div className="flex items-center justify-center gap-3 mb-3">
                <ChefHat className="w-12 h-12 text-orange-600" />
                <h1 className="text-5xl font-bold bg-gradient-to-r from-orange-600 to-amber-600 bg-clip-text text-transparent">Recipe Remixer Pro</h1>
                <Sparkles className="w-12 h-12 text-amber-500" />
              </div>
              <p className="text-gray-600 text-lg mb-4">Transform any recipe with AI ‚Ä¢ Track calories ‚Ä¢ Save favorites ‚Ä¢ Share</p>
              <button onClick={loadExample} className="px-4 py-2 text-sm bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200">Load Example</button>
            </div>

            <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border border-purple-100">
              <h3 className="text-lg font-semibold text-gray-800 mb-3">ü•ó Dietary Preferences</h3>
              <div className="flex flex-wrap gap-3">
                {Object.entries(dietaryRestrictions).map(([key, value]) => (
                  <button key={key} onClick={() => setDietaryRestrictions(prev => ({ ...prev, [key]: !value }))}
                    className={`px-4 py-2 rounded-lg font-medium transition-all ${value ? 'bg-green-500 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                    {value && <Check className="inline w-4 h-4 mr-1" />}
                    {key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}
                  </button>
                ))}
              </div>
            </div>

            <div className="grid lg:grid-cols-3 gap-6 mb-6">
              <div className="lg:col-span-1 bg-white rounded-2xl shadow-lg p-6 border border-orange-100">
                <label className="block text-lg font-semibold text-gray-800 mb-3">üìù Original Recipe</label>
                <textarea value={recipe} onChange={(e) => setRecipe(e.target.value)} placeholder="Paste recipe..." className="w-full h-64 p-4 border-2 border-gray-200 rounded-xl focus:border-orange-400 focus:outline-none resize-none font-mono text-sm" />
              </div>

              <div className="lg:col-span-1 bg-white rounded-2xl shadow-lg p-6 border border-amber-100">
                <label className="block text-lg font-semibold text-gray-800 mb-3">ü•ó Available Ingredients</label>
                <textarea value={inventory} onChange={(e) => setInventory(e.target.value)} placeholder="List ingredients..." className="w-full h-48 p-4 border-2 border-gray-200 rounded-xl focus:border-amber-400 focus:outline-none resize-none" />
                <div className="mt-4">
                  <label className="block">
                    <div className="flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg cursor-pointer hover:from-blue-600 hover:to-purple-600">
                      <Camera className="w-5 h-5" />
                      {imageAnalyzing ? 'Analyzing...' : 'Upload Image'}
                    </div>
                    <input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" disabled={imageAnalyzing} />
                  </label>
                </div>
              </div>

              <div className="lg:col-span-1 bg-white rounded-2xl shadow-lg p-6 border border-green-100">
                <h3 className="text-lg font-semibold text-gray-800 mb-3">üíæ Saved Recipes</h3>
                <div className="space-y-2 max-h-80 overflow-y-auto">
                  {savedRecipes.length === 0 ? (
                    <p className="text-gray-500 text-sm">No saved recipes yet</p>
                  ) : (
                    savedRecipes.map((saved) => (
                      <div key={saved.id} className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <div className="flex justify-between items-start">
                          <button onClick={() => loadRecipe(saved)} className="text-left flex-1 hover:text-orange-600">
                            <p className="font-semibold text-sm">{saved.name}</p>
                            <p className="text-xs text-gray-500">{new Date(saved.timestamp).toLocaleDateString()}</p>
                            {saved.calories && <p className="text-xs text-green-600">{saved.calories} cal</p>}
                          </button>
                          <button onClick={() => deleteRecipe(saved.id)} className="text-red-500 hover:text-red-700 ml-2">
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>

            <div className="text-center mb-6">
              <button onClick={remixRecipe} disabled={loading} className="px-8 py-4 bg-gradient-to-r from-orange-500 to-amber-500 text-white text-lg font-semibold rounded-xl hover:from-orange-600 hover:to-amber-600 transition-all transform hover:scale-105 disabled:opacity-50 shadow-lg inline-flex items-center gap-3">
                {loading ? <><Loader2 className="w-6 h-6 animate-spin" />Remixing...</> : <><Sparkles className="w-6 h-6" />Remix Recipe</>}
              </button>
              {remixedRecipe && (
                <div className="mt-4 flex justify-center gap-3">
                  <button onClick={saveRecipe} className="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 inline-flex items-center gap-2 shadow-md">
                    <Save className="w-5 h-5" />Save
                  </button>
                  <button onClick={shareRecipe} className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 inline-flex items-center gap-2 shadow-md">
                    <Share2 className="w-5 h-5" />Share
                  </button>
                </div>
              )}
            </div>

            {error && (
              <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4 mb-6 flex items-start gap-3">
                <AlertCircle className="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" />
                <p className="text-red-800">{error}</p>
              </div>
            )}

            {remixedRecipe && (
              <div className="grid lg:grid-cols-4 gap-6">
                <div className="lg:col-span-3 bg-white rounded-2xl shadow-xl p-8 border-2 border-green-200">
                  <div className="flex items-center gap-3 mb-6 pb-4 border-b-2 border-green-100">
                    <Check className="w-8 h-8 text-green-600" />
                    <h2 className="text-3xl font-bold text-gray-800">Your Remixed Recipe</h2>
                  </div>
                  <div className="prose prose-orange max-w-none">
                    {remixedRecipe.split('\n').map((line, idx) => {
                      if (line.startsWith('## ')) return <h2 key={idx} className="text-2xl font-bold text-orange-700 mt-6 mb-3">{line.replace('## ', '')}</h2>;
                      if (line.startsWith('### ')) return <h3 key={idx} className="text-xl font-semibold text-amber-700 mt-5 mb-2">{line.replace('### ', '')}</h3>;
                      if (line.startsWith('- ')) return <li key={idx} className="ml-6 my-1 text-gray-700">{line.replace('- ', '')}</li>;
                      if (line.trim() === '') return <br key={idx} />;
                      if (line.match(/^\d+\./)) return <p key={idx} className="ml-6 my-2 text-gray-700">{line}</p>;
                      return <p key={idx} className="my-2 text-gray-700 leading-relaxed">{line}</p>;
                    })}
                  </div>
                </div>

                <div className="lg:col-span-1 space-y-6">
                  {calories && (
                    <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl shadow-lg p-6 border-2 border-green-200">
                      <h3 className="text-lg font-semibold text-gray-800 mb-2">üî• Nutrition</h3>
                      <div className="text-center">
                        <p className="text-4xl font-bold text-green-600">{calories}</p>
                        <p className="text-gray-600">Total Calories</p>
                      </div>
                    </div>
                  )}
                  {shoppingList.length > 0 && (
                    <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-lg p-6 border-2 border-blue-200">
                      <div className="flex items-center gap-2 mb-3">
                        <ShoppingCart className="w-5 h-5 text-blue-600" />
                        <h3 className="text-lg font-semibold text-gray-800">Shopping List</h3>
                      </div>
                      <ul className="space-y-2">
                        {shoppingList.map((item, idx) => (
                          <li key={idx} className="flex items-start gap-2 text-sm">
                            <span className="text-blue-600 mt-1">‚Ä¢</span>
                            <span className="text-gray-700">{item}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              </div>
            )}

            {showShareModal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-2xl font-bold text-gray-800">Share Recipe</h3>
                    <button onClick={() => setShowShareModal(false)} className="text-gray-500 hover:text-gray-700">
                      <X className="w-6 h-6" />
                    </button>
                  </div>
                  <p className="text-gray-600 mb-4">Share this link:</p>
                  <div className="bg-gray-100 p-3 rounded-lg mb-4 break-all text-sm">{shareUrl}</div>
                  <button onClick={copyShareUrl} className="w-full px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Copy Link</button>
                </div>
              </div>
            )}

            <div className="text-center mt-12 text-gray-500 text-sm">
              <p>Made with Love by Ashish ‚Ä¢ Built with React</p>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<RecipeRemixer />, document.getElementById('root'));
  </script>
</body>
</html>